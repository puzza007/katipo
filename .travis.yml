---
sudo: required
dist: xenial
group: edge

language: erlang

install:
  - ORIG_DIR=$PWD
  - export PATH=$PATH:$HOME/.cargo/bin
  - git clone --recursive https://github.com/cloudflare/quiche
  - cd quiche/deps/boringssl
  - mkdir build
  - cd build
  - cmake -DCMAKE_POSITION_INDEPENDENT_CODE=on ..
  - make -j`nproc`
  - cd ..
  - mkdir .openssl/lib -p
  - cp build/crypto/libcrypto.a build/ssl/libssl.a .openssl/lib
  - ln -s $PWD/include .openssl
  - cd ../..
  - QUICHE_BSSL_PATH=$PWD/deps/boringssl cargo build --release --features pkg-config-meta
  - cd ..
  - wget https://github.com/erlang/rebar3/releases/download/3.10.0/rebar3 && chmod 755 rebar3
  - git clone https://github.com/curl/curl
  - cd curl
  - ./buildconf
  - ./configure LDFLAGS="-Wl,-rpath,$PWD/../quiche/target/release" --with-ssl=$PWD/../quiche/deps/boringssl/.openssl --with-quiche=$PWD/../quiche/target/release
  - make -j`nproc`
  - sudo make install
  - cd $ORIG_DIR

otp_release:
  - 21.3
  - 22.0

script:
  - export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
  - ./rebar3 update && ./rebar3 ct && ./rebar3 dialyzer && ./rebar3 coveralls send

before_install:
  - sudo ifconfig
  - sudo apt-get update -q
  - sudo apt-get install -qy build-essential libssl-dev libnghttp2-dev curl git cmake
  - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs |  sh -s -- -y
  - sudo apt purge -y curl && sudo apt autoremove -y

cache:
  directories:
    - $HOME/.cache/rebar3/

addons:
  apt:
    packages:
      - libevent-dev
